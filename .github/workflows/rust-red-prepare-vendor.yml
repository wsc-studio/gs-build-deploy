name: RustRed Vendor Offline Deps
on:
  workflow_dispatch:
    inputs:
      version:
        description: 版本信息
        required: true
jobs:
  vendor:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Prepare vendor offline deps
        env:
          VERSION: ${{ inputs.version }}
        run: |
          cd "$GITHUB_WORKSPACE"
          mkdir -p dist-vendor/vendor/debs dist-vendor/vendor/libreoffice dist-vendor/vendor/msfonts
          mkdir -p dist-vendor/vendor/luarocks dist-vendor/vendor/mongo
          source /etc/os-release || true
          if [ "${ID:-}" = "debian" ] || echo "${ID_LIKE:-}" | grep -qi debian; then
            sudo sed -i 's/main/main contrib non-free/g' /etc/apt/sources.list || true
          fi
          if [ "${ID:-}" = "ubuntu" ] || echo "${ID_LIKE:-}" | grep -qi ubuntu; then
            sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository -y universe || true
            sudo add-apt-repository -y multiverse || true
          fi
          sudo apt-get update
          docker run --rm -v "$PWD/dist-vendor/vendor/debs:/out" ubuntu:22.04 bash -lc '
            set -euo pipefail
            apt-get update
            apt-get install -y software-properties-common apt-rdepends
            add-apt-repository -y universe || true
            add-apt-repository -y multiverse || true
            apt-get update
            PKGS="ffmpeg libpq5 ca-certificates \
              libavcodec-dev libavformat-dev libavutil-dev libavdevice-dev \
              less vim strace fonts-noto libgl1-mesa-glx libnss3 libxinerama1 libglu1-mesa \
              libdbus-glib-1-2 libcups2 libcairo2 libsm6 libfontconfig1 libxrender1 \
              libxext6 libfreetype6 default-jre xvfb libxslt1.1 gpg wget unzip \
              libreadline8 readline-common libncursesw6 libtinfo6 \
              lua5.4 lua5.4-dev libpq-dev cmake clang pkg-config build-essential libssl-dev \
              ttf-mscorefonts-installer cabextract libmspack0"
            DEPS=$(apt-rdepends $PKGS | sed -n 's/^\([a-z0-9][a-z0-9+.-]*\)$/\1/p' | sort -u)
            cd /out
            apt-get download $DEPS
            apt-get install -y dpkg-dev
            (cd /out && dpkg-scanpackages . > Packages && gzip -k Packages)
          '
          wget -O dist-vendor/vendor/libreoffice/LibreOffice_25.2.7_Linux_x86-64_deb.tar.gz \
            https://download.documentfoundation.org/libreoffice/stable/25.2.7/deb/x86_64/LibreOffice_25.2.7_Linux_x86-64_deb.tar.gz
          COREFONTS=(andale32.exe arial32.exe arialb32.exe comic32.exe courie32.exe georgi32.exe impact32.exe times32.exe trebuc32.exe verdan32.exe webdin32.exe)
          for f in "${COREFONTS[@]}"; do
            wget -O "dist-vendor/vendor/msfonts/$f" "https://downloads.sourceforge.net/corefonts/$f" || true
          done
          wget -O dist-vendor/vendor/luarocks/luarocks-3.11.1.tar.gz https://luarocks.org/releases/luarocks-3.11.1.tar.gz
          wget -O dist-vendor/vendor/mongo/mongo-c-driver-1.27.6.tar.gz https://github.com/mongodb/mongo-c-driver/releases/download/1.27.6/mongo-c-driver-1.27.6.tar.gz
          sudo apt-get install -y lua5.4 lua5.4-dev make gcc cmake pkg-config libssl-dev libpq-dev
          tar -xzf dist-vendor/vendor/luarocks/luarocks-3.11.1.tar.gz -C /tmp
          cd /tmp/luarocks-3.11.1
          ./configure --with-lua=/usr --with-lua-include=/usr/include/lua5.4
          make
          sudo make install
          cd -
          REPO_DIR="$GITHUB_WORKSPACE/dist-vendor/vendor/luarocks"
          ROCKS_DIR="$REPO_DIR/rocks"
          mkdir -p "$ROCKS_DIR"
          luarocks --lua-version=5.4 config local_by_default true
          sudo ln -sf /usr/include/postgresql/libpq-fe.h /usr/include/libpq-fe.h || true
          MODS="luasql-postgres lua-cjson luaossl jsonschema luasocket luasystem uuid luasec"
          for m in $MODS; do luarocks install "$m" PGSQL_INCDIR=/usr/include/postgresql PGSQL_LIBDIR=/usr/lib/x86_64-linux-gnu LUA_INCDIR=/usr/include/lua5.4 --lua-version=5.4 --local || exit 1; luarocks pack "$m" || exit 1; done
          mv ./*.rock "$ROCKS_DIR" 2>/dev/null || true
          TMPM=/tmp/mongo-c-driver-1.27.6
          mkdir -p "$TMPM"
          tar -xzf dist-vendor/vendor/mongo/mongo-c-driver-1.27.6.tar.gz -C /tmp
          cd "$TMPM" || cd /tmp/mongo-c-driver-1.27.6
          SOURCE=$(pwd)
          BUILD="$SOURCE/_build"
          PREFIX="$SOURCE/_install"
          cmake -S "$SOURCE" -B "$BUILD" -D ENABLE_EXTRA_ALIGNMENT=OFF -D ENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF -D CMAKE_BUILD_TYPE=RelWithDebInfo -D ENABLE_MONGOC=ON
          cmake --build "$BUILD" --config RelWithDebInfo --parallel
          cmake --install "$BUILD" --prefix "$PREFIX" --config RelWithDebInfo
          export LIBBSON_DIR="$PREFIX" LIBMONGOC_DIR="$PREFIX"
          LUA_INCDIR=/usr/include/lua5.4 luarocks install lua-mongo LIBBSON_DIR="$PREFIX" LIBBSON_INCDIR="$PREFIX/include" LIBBSON_LIBDIR="$PREFIX/lib" LIBMONGOC_DIR="$PREFIX" LIBMONGOC_INCDIR="$PREFIX/include" LIBMONGOC_LIBDIR="$PREFIX/lib" --lua-version=5.4 --local || exit 1
          luarocks pack lua-mongo || exit 1
          mv lua-mongo-*.rock "$ROCKS_DIR"
          luarocks-admin make-manifest "$REPO_DIR"
          cat <<'SH' > "$GITHUB_WORKSPACE/dist-vendor/install-deps.sh"
          #!/usr/bin/env bash
          set -euo pipefail
          BASE=$(cd "$(dirname "$0")" && pwd)
          DEBS="$BASE/vendor/debs"
          LIBO_DIR="$BASE/vendor/libreoffice"
          MSF="$BASE/vendor/msfonts"
          LR_DIR="$BASE/vendor/luarocks"
          MONGO_DIR="$BASE/vendor/mongo"
          if command -v sudo >/dev/null 2>&1; then SUDO=sudo; else SUDO=; fi
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | $SUDO debconf-set-selections || true
          $SUDO mkdir -p /var/lib/ttf-mscorefonts-installer/files || true
          $SUDO cp "$MSF"/*.exe /var/lib/ttf-mscorefonts-installer/files/ 2>/dev/null || true
          SRC_BAK="/etc/apt/sources.list.bak"
          SRCD_DIR="/etc/apt/sources.list.d"
          SRCD_BAK="/etc/apt/sources.list.d.bak"
          if [ -f /etc/apt/sources.list ]; then $SUDO cp -a /etc/apt/sources.list "$SRC_BAK"; fi
          if [ -d "$SRCD_DIR" ]; then $SUDO mkdir -p "$SRCD_BAK"; $SUDO cp -a "$SRCD_DIR"/*.list "$SRCD_BAK"/ 2>/dev/null || true; fi
          $SUDO rm -f /etc/apt/sources.list
          $SUDO rm -f "$SRCD_DIR"/*.list 2>/dev/null || true
          echo "deb [trusted=yes] file:$DEBS ./" | $SUDO tee /etc/apt/sources.list
          $SUDO apt-get update
          $SUDO apt-get install -y --no-install-recommends \
            ffmpeg \
            libpq5 ca-certificates \
            libavcodec58 libavformat58 libavutil56 libavdevice58 \
            less vim strace fonts-noto libgl1-mesa-glx libnss3 libxinerama1 libglu1-mesa \
            libdbus-glib-1-2 libcups2 libcairo2 libsm6 libfontconfig1 libxrender1 \
            libxext6 libfreetype6 default-jre xvfb libxslt1.1 gpg wget unzip \
            libreadline8 readline-common libncursesw6 libtinfo6 \
            lua5.4 lua5.4-dev libpq-dev cmake clang pkg-config build-essential libssl-dev \
            ttf-mscorefonts-installer
          lua5.4 -v || true
          unzip -v || true
          $SUDO ldconfig
          if [ -f "$SRC_BAK" ]; then $SUDO mv -f "$SRC_BAK" /etc/apt/sources.list; else $SUDO rm -f /etc/apt/sources.list; fi
          $SUDO rm -f "$SRCD_DIR"/*.list 2>/dev/null || true
          if [ -d "$SRCD_BAK" ]; then $SUDO mkdir -p "$SRCD_DIR"; $SUDO cp -a "$SRCD_BAK"/*.list "$SRCD_DIR"/ 2>/dev/null || true; fi
          cd "$LIBO_DIR"
          tar -xzf LibreOffice_*.tar.gz
          $SUDO dpkg -i LibreOffice_*/DEBS/*.deb
          $SUDO ldconfig
          cd "$LR_DIR"
          tar -xzf luarocks-*.tar.gz
          cd "$(ls -d luarocks-*/ | head -n1)"
          ./configure --with-lua=/usr --with-lua-include=/usr/include/lua5.4
          make
          $SUDO make install
          luarocks --lua-version=5.4 config local_by_default true
          ROCKDIR="$LR_DIR"
          $SUDO ln -sf /usr/include/postgresql/libpq-fe.h /usr/include/libpq-fe.h || true
          PGSQL_INCDIR=/usr/include/postgresql
          PGSQL_LIBDIR=/usr/lib/x86_64-linux-gnu
          LUA_INCDIR=/usr/include/lua5.4
          MODS="luasql-postgres lua-cjson luaossl jsonschema luasocket luasystem uuid luasec"
          for m in $MODS; do luarocks install "$m" PGSQL_INCDIR="$PGSQL_INCDIR" PGSQL_LIBDIR="$PGSQL_LIBDIR" LUA_INCDIR="$LUA_INCDIR" --lua-version=5.4 --server="file://$ROCKDIR" --only-server --local || exit 1; done
          cd "$MONGO_DIR"
          tar -xzf mongo-c-driver-*.tar.gz
          cd "$(ls -d mongo-c-driver-*/ | head -n1)"
          SOURCE=$(pwd)
          BUILD="$SOURCE/_build"
          VERSION=$(echo "$SOURCE" | sed 's/.*mongo-c-driver-\([0-9.]*\).*/\1/')
          PREFIX="$SOURCE/_install"
          cmake -S "$SOURCE" -B "$BUILD" -D ENABLE_EXTRA_ALIGNMENT=OFF -D ENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF -D CMAKE_BUILD_TYPE=RelWithDebInfo -D BUILD_VERSION="$VERSION" -D ENABLE_MONGOC=ON
          cmake --build "$BUILD" --config RelWithDebInfo --parallel
          $SUDO cmake --install "$BUILD" --prefix "$PREFIX" --config RelWithDebInfo
          $SUDO ldconfig
          LIB_PREFIX="$PREFIX"
          luarocks install lua-mongo LIBBSON_DIR="$LIB_PREFIX" LIBBSON_INCDIR="$LIB_PREFIX/include" LIBBSON_LIBDIR="$LIB_PREFIX/lib" LIBMONGOC_DIR="$LIB_PREFIX" LIBMONGOC_INCDIR="$LIB_PREFIX/include" LIBMONGOC_LIBDIR="$LIB_PREFIX/lib" LUA_INCDIR="$LUA_INCDIR" --lua-version=5.4 --server="file://$ROCKDIR" --only-server --local || exit 1
          SH
          chmod +x "$GITHUB_WORKSPACE/dist-vendor/install-deps.sh"
          cat > "$GITHUB_WORKSPACE/dist-vendor/env.sh" <<'ENV'
          export PATH="/opt/libreoffice25.2/program:${PATH}"
          export PYTHONHOME="/opt/libreoffice25.2/program/python-core-3.10.16"
          ENV
          printf "%s" "$VERSION" > "$GITHUB_WORKSPACE/dist-vendor/VERSION"
          tar -czf "$GITHUB_WORKSPACE/rust-red-vendor.tar.gz" -C "$GITHUB_WORKSPACE/dist-vendor" .
      - name: Upload vendor artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-red-vendor
          path: rust-red-vendor.tar.gz
      - name: Validate offline install in container
        run: |
          docker pull ubuntu:22.04
          docker run --rm --network none -v "$PWD/dist-vendor:/dist-vendor" ubuntu:22.04 bash -lc "/dist-vendor/install-deps.sh"
